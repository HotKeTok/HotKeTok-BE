<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>HotKeTok WebSocket Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 20px auto; padding: 20px; background-color: #f9f9f9; }
        h1, h2 { color: #555; }
        .container { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], input[type="number"] { width: calc(100% - 20px); padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #messages { margin-top: 20px; padding: 15px; border: 1px solid #eee; border-radius: 4px; height: 300px; overflow-y: auto; background: #fafafa; white-space: pre-wrap; word-wrap: break-word; }
        .status { padding: 10px; border-radius: 4px; margin-bottom: 15px; }
        .connected { background-color: #e7f7e7; color: #3c763d; }
        .disconnected { background-color: #f7e7e7; color: #a94442; }
    </style>
</head>
<body>

<div class="container">
    <h1>WebSocket 실시간 채팅 테스트</h1>
    <div id="status" class="status disconnected">연결 상태: 끊김</div>

    <div class="form-group">
        <button id="connectBtn">1. 서버 연결</button>
        <button id="disconnectBtn" disabled>연결 끊기</button>
    </div>

    <hr>

    <h2>채팅방 참여 및 메시지 전송</h2>
    <div class="form-group">
        <label for="roomId">채팅방 ID (Room ID):</label>
        <input type="number" id="roomId" placeholder="예: 1 (Postman으로 생성한 ID)">
        <button id="subscribeBtn" disabled>2. 채팅방 구독</button>
    </div>
    <div class="form-group">
        <label for="senderId">보내는 사람 ID (Sender ID):</label>
        <input type="number" id="senderId" placeholder="예: 101">
    </div>
    <div class="form-group">
        <label for="message">메시지 내용:</label>
        <input type="text" id="message" placeholder="메시지를 입력하세요...">
        <button id="sendBtn" disabled>3. 메시지 전송</button>
    </div>

    <h2>수신된 메시지</h2>
    <div id="messages"></div>
</div>

<script>
    let stompClient = null;

    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const subscribeBtn = document.getElementById('subscribeBtn');
    const sendBtn = document.getElementById('sendBtn');
    const statusDiv = document.getElementById('status');
    const messagesDiv = document.getElementById('messages');

    connectBtn.addEventListener('click', connect);
    disconnectBtn.addEventListener('click', disconnect);
    subscribeBtn.addEventListener('click', subscribeToRoom);
    sendBtn.addEventListener('click', sendMessage);

    function setConnected(connected) {
        connectBtn.disabled = connected;
        disconnectBtn.disabled = !connected;
        subscribeBtn.disabled = !connected;
        sendBtn.disabled = !connected;

        if (connected) {
            statusDiv.textContent = '연결 상태: 연결됨';
            statusDiv.className = 'status connected';
        } else {
            statusDiv.textContent = '연결 상태: 끊김';
            statusDiv.className = 'status disconnected';
            sendBtn.disabled = true;
            subscribeBtn.disabled = true;
        }
    }

    function connect() {
        const socket = new SockJS('http://localhost:8086/ws-stomp'); // 서버의 Websocket 엔드포인트
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            setConnected(true);
            log('서버에 연결되었습니다: ' + frame);
        }, function(error) {
            log('연결 실패: ' + error);
            setConnected(false);
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        setConnected(false);
        log("연결이 끊어졌습니다.");
    }

    function subscribeToRoom() {
        const roomId = document.getElementById('roomId').value;
        if (!roomId) {
            alert('채팅방 ID를 입력하세요.');
            return;
        }

        stompClient.subscribe('/sub/chat/room/' + roomId, function (message) {
            const receivedMessage = JSON.parse(message.body);
            log('메시지 수신: ' + message.body);
        });

        log(roomId + '번 채팅방을 구독 시작합니다.');
        alert(roomId + '번 채팅방을 구독했습니다! 이제 메시지를 보낼 수 있습니다.');
    }

    function sendMessage() {
        const roomId = document.getElementById('roomId').value;
        const senderId = document.getElementById('senderId').value;
        const content = document.getElementById('message').value;

        if (!roomId || !senderId || !content) {
            alert('채팅방 ID, 보내는 사람 ID, 메시지 내용을 모두 입력하세요.');
            return;
        }

        stompClient.send("/pub/chat/message", {}, JSON.stringify({
            'roomId': Number(roomId),
            'senderId': Number(senderId),
            'content': content
        }));

        log('메시지 전송: ' + content);
        document.getElementById('message').value = '';
    }

    function log(message) {
        const p = document.createElement('p');
        p.style.margin = '5px 0';
        p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        messagesDiv.appendChild(p);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

</script>
</body>
</html>
